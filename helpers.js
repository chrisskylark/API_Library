"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.getConfig = exports.injectDate = exports.shortMonthName = exports.monthName = exports.decodeBody = exports.getDistanceFromLatLonInKm = exports.sendMessage = exports.getMgmt = exports.currentConfig = exports.calculateAge = exports.spliceString = exports.hasAllKeys = exports.uuidv4 = exports.zeroPad = exports.daysBetween = exports.minutesFromDuration = exports.tryParse = exports.randomInt = exports.randomDate = exports.disconnectMySQL = exports.getMySQLClient = exports.lambda = void 0;
const AWS = __importStar(require("aws-sdk"));
const _ = __importStar(require("lodash"));
const crypto = __importStar(require("crypto"));
const getConfig_1 = require("./getConfig");
Object.defineProperty(exports, "getConfig", { enumerable: true, get: function () { return getConfig_1.getConfig; } });
const mysql = __importStar(require("mysql2/promise"));
let apigwManagementApi = null;
exports.lambda = new AWS.Lambda();
let MYSQL = null;
async function getMySQLClient() {
    if (MYSQL)
        return MYSQL;
    const config = await (0, getConfig_1.getConfig)();
    if (!config || !config.mysql)
        throw new Error('Config/MySQL Config could not be retrieved');
    try {
        MYSQL = await mysql.createConnection(config.mysql);
        await MYSQL.connect();
        return MYSQL;
    }
    catch (error) {
        console.error('Cannot connect to MySQL server ', error);
    }
    return null;
}
exports.getMySQLClient = getMySQLClient;
async function disconnectMySQL() {
    if (MYSQL && MYSQL)
        await MYSQL.end();
    MYSQL = null;
    return true;
}
exports.disconnectMySQL = disconnectMySQL;
function randomDate(start, end) {
    end = end || new Date();
    return new Date(start.getTime() + Math.random() * (end.getTime() - start.getTime()));
}
exports.randomDate = randomDate;
function randomInt(min, max) {
    return crypto.randomInt(min, max);
}
exports.randomInt = randomInt;
function tryParse(json) {
    try {
        return JSON.parse(json);
    }
    catch (e) {
        return {};
    }
}
exports.tryParse = tryParse;
function minutesFromDuration(duration) {
    let stages;
    if (duration.includes(':')) {
        stages = duration.split(':');
        if (stages.length == 0) {
            stages = '1:00:00'.split(':');
        }
        else if (stages.length > 2) {
            stages = 60 * stages[0] + stages[1] * 1;
        }
        else if ((stages.length = 2)) {
            stages = 1 * stages[0];
        }
        if (isNaN(stages) || stages < 10)
            stages = 60;
    }
    else {
        stages = Number.parseInt(duration);
        if (_.isNaN(stages))
            stages = 60;
    }
    return stages;
}
exports.minutesFromDuration = minutesFromDuration;
function daysBetween(firstDate, secondDate) {
    const oneDay = 24 * 60 * 60 * 1000;
    const diffDays = Math.round(Math.abs((firstDate.getTime() - secondDate.getTime()) / oneDay));
    return diffDays;
}
exports.daysBetween = daysBetween;
function zeroPad(num, places) {
    return String(num).padStart(places, '0');
}
exports.zeroPad = zeroPad;
function uuidv4() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
        var r = (Math.random() * 16) | 0, v = c == 'x' ? r : (r & 0x3) | 0x8;
        return v.toString(16);
    });
}
exports.uuidv4 = uuidv4;
function hasAllKeys(obj, keys) {
    let has = true;
    keys.forEach((k) => {
        has = has && Object.prototype.hasOwnProperty.call(obj, k);
    });
    return has;
}
exports.hasAllKeys = hasAllKeys;
function spliceString(string, index, count = 0, insert = '') {
    const array = _.toArray(string);
    array.splice(index, count, insert);
    return array.join('');
}
exports.spliceString = spliceString;
function calculateAge(birthday) {
    var ageDifMs = Date.now() - birthday.getTime();
    var ageDate = new Date(ageDifMs);
    return Math.abs(ageDate.getUTCFullYear() - 1970);
}
exports.calculateAge = calculateAge;
async function currentConfig() {
    let config = await (0, getConfig_1.getConfig)();
    return config;
}
exports.currentConfig = currentConfig;
function getMgmt(event) {
    if (apigwManagementApi)
        return apigwManagementApi;
    apigwManagementApi = new AWS.ApiGatewayManagementApi({
        apiVersion: '2018-11-29',
        endpoint: event.requestContext.domainName + '/' + event.requestContext.stage,
    });
    return apigwManagementApi;
}
exports.getMgmt = getMgmt;
async function sendMessage(to, action, data) {
    data.action = action;
    try {
        if (apigwManagementApi) {
            await apigwManagementApi
                .postToConnection({
                ConnectionId: to,
                Data: JSON.stringify(data),
            })
                .promise();
            return true;
        }
        return false;
    }
    catch (e) {
        console.log('Error sending message ', e);
        return false;
    }
}
exports.sendMessage = sendMessage;
function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
    var R = 6371;
    var dLat = deg2rad(lat2 - lat1);
    var dLon = deg2rad(lon2 - lon1);
    var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    var d = R * c;
    return d;
}
exports.getDistanceFromLatLonInKm = getDistanceFromLatLonInKm;
function deg2rad(deg) {
    return deg * (Math.PI / 180);
}
function decodeBody(event) {
    let bodyRaw = event.body;
    let body = event.body;
    let bodyJSON;
    if (event.isBase64Encoded) {
        body = Buffer.from(bodyRaw, 'base64').toString('utf8');
    }
    try {
        bodyJSON = JSON.parse(body);
        return bodyJSON;
    }
    catch (_a) {
        return body;
    }
}
exports.decodeBody = decodeBody;
function monthName(month) {
    let months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    if (month < 0 || month > 11)
        throw new Error("Invalid month number");
    return months[month];
}
exports.monthName = monthName;
function shortMonthName(month) {
    return monthName(month).substring(0, 3).toUpperCase();
}
exports.shortMonthName = shortMonthName;
function injectDate(text) {
    function pad(n) {
        return n < 10 ? '0' + n : '' + n;
    }
    let timeNow = new Date();
    text = text.replace(/%sm/g, shortMonthName(timeNow.getMonth()));
    text = text.replace(/%lm/g, monthName(timeNow.getMonth()));
    text = text.replace(/%d/g, pad(timeNow.getDate()));
    text = text.replace(/%m/g, pad(timeNow.getMonth() + 1));
    text = text.replace(/%y/g, pad(timeNow.getFullYear()));
    text = text.replace(/%h/g, pad(timeNow.getHours()));
    text = text.replace(/%n/g, pad(timeNow.getMinutes()));
    text = text.replace(/%s/g, pad(timeNow.getSeconds()));
    text = text.replace(/%l/g, pad(timeNow.getMilliseconds()));
    return text;
}
exports.injectDate = injectDate;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGVscGVycy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImhlbHBlcnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDZDQUErQjtBQUMvQiwwQ0FBNEI7QUFDNUIsK0NBQWlDO0FBRWpDLDJDQUFrRDtBQWlRMUMsMEZBalFZLHFCQUFTLE9BaVFaO0FBOVBqQixzREFBd0M7QUFDeEMsSUFBSSxrQkFBa0IsR0FBdUMsSUFBSSxDQUFDO0FBU3JELFFBQUEsTUFBTSxHQUFHLElBQUksR0FBRyxDQUFDLE1BQU0sRUFBRSxDQUFDO0FBRXZDLElBQUksS0FBSyxHQUE0QixJQUFJLENBQUM7QUEwQ25DLEtBQUssVUFBVSxjQUFjO0lBQ2xDLElBQUksS0FBSztRQUFFLE9BQU8sS0FBSyxDQUFDO0lBQ3hCLE1BQU0sTUFBTSxHQUFHLE1BQU0sSUFBQSxxQkFBUyxHQUFFLENBQUM7SUFDakMsSUFBSSxDQUFDLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLO1FBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyw0Q0FBNEMsQ0FBQyxDQUFDO0lBQzVGLElBQUk7UUFDRixLQUFLLEdBQUcsTUFBTSxLQUFLLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ25ELE1BQU0sS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQ3RCLE9BQU8sS0FBSyxDQUFDO0tBQ2Q7SUFBQyxPQUFPLEtBQUssRUFBRTtRQUNkLE9BQU8sQ0FBQyxLQUFLLENBQUMsaUNBQWlDLEVBQUUsS0FBSyxDQUFDLENBQUM7S0FDekQ7SUFDRCxPQUFPLElBQUksQ0FBQztBQUNkLENBQUM7QUFaRCx3Q0FZQztBQUNNLEtBQUssVUFBVSxlQUFlO0lBQ25DLElBQUksS0FBSyxJQUFJLEtBQUs7UUFBRSxNQUFNLEtBQUssQ0FBQyxHQUFHLEVBQUUsQ0FBQztJQUN0QyxLQUFLLEdBQUcsSUFBSSxDQUFDO0lBQ2IsT0FBTyxJQUFJLENBQUM7QUFDZCxDQUFDO0FBSkQsMENBSUM7QUFJRCxTQUFnQixVQUFVLENBQUMsS0FBVyxFQUFFLEdBQVU7SUFDaEQsR0FBRyxHQUFHLEdBQUcsSUFBSSxJQUFJLElBQUksRUFBRSxDQUFDO0lBQ3hCLE9BQU8sSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sRUFBRSxHQUFHLElBQUksQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsR0FBRyxLQUFLLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFDO0FBQ3ZGLENBQUM7QUFIRCxnQ0FHQztBQUVELFNBQWdCLFNBQVMsQ0FBQyxHQUFXLEVBQUUsR0FBVztJQUNoRCxPQUFPLE1BQU0sQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0FBQ3BDLENBQUM7QUFGRCw4QkFFQztBQUVELFNBQWdCLFFBQVEsQ0FBQyxJQUFZO0lBQ25DLElBQUk7UUFDRixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7S0FDekI7SUFBQyxPQUFPLENBQUMsRUFBRTtRQUNWLE9BQU8sRUFBRSxDQUFDO0tBQ1g7QUFDSCxDQUFDO0FBTkQsNEJBTUM7QUFFRCxTQUFnQixtQkFBbUIsQ0FBQyxRQUFnQjtJQUNsRCxJQUFJLE1BQVcsQ0FBQztJQUNoQixJQUFJLFFBQVEsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEVBQUU7UUFDMUIsTUFBTSxHQUFHLFFBQVEsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDN0IsSUFBSSxNQUFNLENBQUMsTUFBTSxJQUFJLENBQUMsRUFBRTtZQUN0QixNQUFNLEdBQUcsU0FBUyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUMvQjthQUFNLElBQUksTUFBTSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDNUIsTUFBTSxHQUFHLEVBQUUsR0FBRyxNQUFNLENBQUMsQ0FBQyxDQUFDLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUN6QzthQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxFQUFFO1lBQzlCLE1BQU0sR0FBRyxDQUFDLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQ3hCO1FBRUQsSUFBSSxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksTUFBTSxHQUFHLEVBQUU7WUFBRSxNQUFNLEdBQUcsRUFBRSxDQUFDO0tBQy9DO1NBQU07UUFDTCxNQUFNLEdBQUcsTUFBTSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUNuQyxJQUFJLENBQUMsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDO1lBQUUsTUFBTSxHQUFHLEVBQUUsQ0FBQztLQUNsQztJQUVELE9BQU8sTUFBTSxDQUFDO0FBQ2hCLENBQUM7QUFuQkQsa0RBbUJDO0FBQ0QsU0FBZ0IsV0FBVyxDQUFDLFNBQWUsRUFBRSxVQUFnQjtJQUMzRCxNQUFNLE1BQU0sR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUM7SUFDbkMsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsU0FBUyxDQUFDLE9BQU8sRUFBRSxHQUFHLFVBQVUsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxDQUFDLENBQUM7SUFDN0YsT0FBTyxRQUFRLENBQUM7QUFDbEIsQ0FBQztBQUpELGtDQUlDO0FBQ0QsU0FBZ0IsT0FBTyxDQUFDLEdBQVcsRUFBRSxNQUFjO0lBQ2pELE9BQU8sTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLENBQUM7QUFDM0MsQ0FBQztBQUZELDBCQUVDO0FBRUQsU0FBZ0IsTUFBTTtJQUNwQixPQUFPLHNDQUFzQyxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsVUFBVSxDQUFDO1FBQ3hFLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFDOUIsQ0FBQyxHQUFHLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDLEdBQUcsR0FBRyxDQUFDO1FBQ3JDLE9BQU8sQ0FBQyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUN4QixDQUFDLENBQUMsQ0FBQztBQUNMLENBQUM7QUFORCx3QkFNQztBQUVELFNBQWdCLFVBQVUsQ0FBQyxHQUFXLEVBQUUsSUFBYztJQUNwRCxJQUFJLEdBQUcsR0FBRyxJQUFJLENBQUM7SUFDZixJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBUyxFQUFFLEVBQUU7UUFDekIsR0FBRyxHQUFHLEdBQUcsSUFBSSxNQUFNLENBQUMsU0FBUyxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQzVELENBQUMsQ0FBQyxDQUFDO0lBQ0gsT0FBTyxHQUFHLENBQUM7QUFDYixDQUFDO0FBTkQsZ0NBTUM7QUFFRCxTQUFnQixZQUFZLENBQUMsTUFBYyxFQUFFLEtBQWEsRUFBRSxRQUFnQixDQUFDLEVBQUUsU0FBaUIsRUFBRTtJQUNoRyxNQUFNLEtBQUssR0FBRyxDQUFDLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ2hDLEtBQUssQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLEtBQUssRUFBRSxNQUFNLENBQUMsQ0FBQztJQUNuQyxPQUFPLEtBQUssQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDeEIsQ0FBQztBQUpELG9DQUlDO0FBR0QsU0FBZ0IsWUFBWSxDQUFDLFFBQWM7SUFFekMsSUFBSSxRQUFRLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLFFBQVEsQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUMvQyxJQUFJLE9BQU8sR0FBRyxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUNqQyxPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLGNBQWMsRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDO0FBQ25ELENBQUM7QUFMRCxvQ0FLQztBQUVNLEtBQUssVUFBVSxhQUFhO0lBQ2pDLElBQUksTUFBTSxHQUFHLE1BQU0sSUFBQSxxQkFBUyxHQUFFLENBQUM7SUFDL0IsT0FBTyxNQUFNLENBQUM7QUFDaEIsQ0FBQztBQUhELHNDQUdDO0FBT0QsU0FBZ0IsT0FBTyxDQUFDLEtBQVU7SUFDaEMsSUFBSSxrQkFBa0I7UUFBRSxPQUFPLGtCQUFrQixDQUFDO0lBQ2xELGtCQUFrQixHQUFHLElBQUksR0FBRyxDQUFDLHVCQUF1QixDQUFDO1FBQ25ELFVBQVUsRUFBRSxZQUFZO1FBQ3hCLFFBQVEsRUFBRSxLQUFLLENBQUMsY0FBYyxDQUFDLFVBQVUsR0FBRyxHQUFHLEdBQUcsS0FBSyxDQUFDLGNBQWMsQ0FBQyxLQUFLO0tBQzdFLENBQUMsQ0FBQztJQUNILE9BQU8sa0JBQWtCLENBQUM7QUFDNUIsQ0FBQztBQVBELDBCQU9DO0FBU00sS0FBSyxVQUFVLFdBQVcsQ0FBQyxFQUFVLEVBQUUsTUFBYyxFQUFFLElBQVM7SUFDckUsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7SUFDckIsSUFBSTtRQUNGLElBQUksa0JBQWtCLEVBQUU7WUFDdEIsTUFBTSxrQkFBa0I7aUJBQ3JCLGdCQUFnQixDQUFDO2dCQUNoQixZQUFZLEVBQUUsRUFBRTtnQkFDaEIsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDO2FBQzNCLENBQUM7aUJBQ0QsT0FBTyxFQUFFLENBQUM7WUFDYixPQUFPLElBQUksQ0FBQztTQUNiO1FBQ0QsT0FBTyxLQUFLLENBQUM7S0FDZDtJQUFDLE9BQU8sQ0FBQyxFQUFFO1FBQ1YsT0FBTyxDQUFDLEdBQUcsQ0FBQyx3QkFBd0IsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUN6QyxPQUFPLEtBQUssQ0FBQztLQUNkO0FBQ0gsQ0FBQztBQWpCRCxrQ0FpQkM7QUFFRCxTQUFnQix5QkFBeUIsQ0FBQyxJQUFZLEVBQUUsSUFBWSxFQUFFLElBQVksRUFBRSxJQUFZO0lBQzlGLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQztJQUNiLElBQUksSUFBSSxHQUFHLE9BQU8sQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLENBQUM7SUFDaEMsSUFBSSxJQUFJLEdBQUcsT0FBTyxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsQ0FBQztJQUNoQyxJQUFJLENBQUMsR0FDSCxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksR0FBRyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksR0FBRyxDQUFDLENBQUM7UUFDdkMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQzlGLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUN2RCxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ2QsT0FBTyxDQUFDLENBQUM7QUFDWCxDQUFDO0FBVkQsOERBVUM7QUFFRCxTQUFTLE9BQU8sQ0FBQyxHQUFXO0lBQzFCLE9BQU8sR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsR0FBRyxHQUFHLENBQUMsQ0FBQztBQUMvQixDQUFDO0FBRUQsU0FBZ0IsVUFBVSxDQUFDLEtBQVU7SUFDbkMsSUFBSSxPQUFPLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQztJQUN6QixJQUFJLElBQUksR0FBVyxLQUFLLENBQUMsSUFBSSxDQUFDO0lBQzlCLElBQUksUUFBYSxDQUFDO0lBQ2xCLElBQUksS0FBSyxDQUFDLGVBQWUsRUFBRTtRQUN6QixJQUFJLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsUUFBUSxDQUFDLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0tBQ3hEO0lBQ0QsSUFBSTtRQUNGLFFBQVEsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzVCLE9BQU8sUUFBUSxDQUFDO0tBQ2pCO0lBQUMsV0FBTTtRQUNOLE9BQU8sSUFBSSxDQUFDO0tBQ2I7QUFDSCxDQUFDO0FBYkQsZ0NBYUM7QUFDRCxTQUFnQixTQUFTLENBQUMsS0FBYTtJQUNyQyxJQUFJLE1BQU0sR0FBSSxDQUFDLFNBQVMsRUFBRSxVQUFVLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFDLE1BQU0sRUFBRSxRQUFRLEVBQUUsV0FBVyxFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQUUsVUFBVSxDQUFDLENBQUE7SUFDdkksSUFBRyxLQUFLLEdBQUcsQ0FBQyxJQUFJLEtBQUssR0FBRyxFQUFFO1FBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyxzQkFBc0IsQ0FBQyxDQUFBO0lBQ25FLE9BQU8sTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFBO0FBQ3RCLENBQUM7QUFKRCw4QkFJQztBQUVELFNBQWdCLGNBQWMsQ0FBQyxLQUFhO0lBQzFDLE9BQU8sU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUMsQ0FBQyxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7QUFDdkQsQ0FBQztBQUZELHdDQUVDO0FBRUQsU0FBZ0IsVUFBVSxDQUFDLElBQVk7SUFDckMsU0FBUyxHQUFHLENBQUMsQ0FBUztRQUNwQixPQUFPLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDbkMsQ0FBQztJQUNELElBQUksT0FBTyxHQUFHLElBQUksSUFBSSxFQUFFLENBQUM7SUFDekIsSUFBSSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLGNBQWMsQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQ2hFLElBQUksR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxTQUFTLENBQUMsT0FBTyxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUMzRCxJQUFJLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDbkQsSUFBSSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLEdBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUN0RCxJQUFJLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDdkQsSUFBSSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQ3BELElBQUksR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsT0FBTyxDQUFDLFVBQVUsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUN0RCxJQUFJLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLE9BQU8sQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDdEQsSUFBSSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxPQUFPLENBQUMsZUFBZSxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBRTNELE9BQU8sSUFBSSxDQUFDO0FBQ2QsQ0FBQztBQWhCRCxnQ0FnQkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBBV1MgZnJvbSAnYXdzLXNkayc7XG5pbXBvcnQgKiBhcyBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgKiBhcyBjcnlwdG8gZnJvbSAnY3J5cHRvJztcbi8vIGltcG9ydCAqIGFzIHNlY3JldHMgZnJvbSAnLi8uc2VjcmV0cy5qc29uJztcbmltcG9ydCB7Q29uZmlnRGF0YSwgZ2V0Q29uZmlnfSBmcm9tICcuL2dldENvbmZpZyc7XG4vLyBpbXBvcnQge09iamVjdElkLCBjb25uZWN0TW9uZ28sIFN0b3JlVHlwZX0gZnJvbSAnLi9nZXRNb25nb0NsaWVudCc7XG4vLyBpbXBvcnQge0RifSBmcm9tICdtb25nb2RiJztcbmltcG9ydCAqIGFzIG15c3FsIGZyb20gJ215c3FsMi9wcm9taXNlJztcbmxldCBhcGlnd01hbmFnZW1lbnRBcGk6IEFXUy5BcGlHYXRld2F5TWFuYWdlbWVudEFwaSB8IG51bGwgPSBudWxsO1xuLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbi8vIPCfk5vwn5Ob8J+Tm/Cfk5vwn5Ob8J+Tm/Cfk5vwn5Ob8J+Tm/Cfk5vwn5Ob8J+Tm/Cfk5vwn5Ob8J+Tm/Cfk5vwn5Ob8J+Tm/Cfk5vwn5Ob8J+Tm/Cfk5vwn5Ob8J+Tm/Cfk5vwn5Ob8J+Tm/Cfk5vwn5Ob8J+Tm1xuLy8gUkVNT1ZFIGR5bmFtb0NvbmZpZyBiZWZvcmUgZ29pbmcgbGl2ZVxuLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbi8vIGV4cG9ydCBjb25zdCBsYW1iZGEgPSBuZXcgQVdTLkxhbWJkYShzZWNyZXRzKTtcbi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4vLyDwn5Ob8J+Tm/Cfk5vwn5Ob8J+Tm/Cfk5vwn5Ob8J+Tm/Cfk5vwn5Ob8J+Tm/Cfk5vwn5Ob8J+Tm/Cfk5vwn5Ob8J+Tm/Cfk5vwn5Ob8J+Tm/Cfk5vwn5Ob8J+Tm/Cfk5vwn5Ob8J+Tm/Cfk5vwn5Ob8J+Tm/Cfk5tcbi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5leHBvcnQgY29uc3QgbGFtYmRhID0gbmV3IEFXUy5MYW1iZGEoKTtcbi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5sZXQgTVlTUUw6IG15c3FsLkNvbm5lY3Rpb24gfCBudWxsID0gbnVsbDtcbi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4vLyDilaYg4pWm4pWU4pWQ4pWX4pWmICDilZTilZDilZfilZTilZDilZfilabilZDilZfilZTilZDilZdcbi8vIOKVoOKVkOKVo+KVkeKVoyDilZEgIOKVoOKVkOKVneKVkeKVoyDilaDilabilZ3ilZrilZDilZdcbi8vIOKVqSDilanilZrilZDilZ3ilanilZDilZ3ilakgIOKVmuKVkOKVneKVqeKVmuKVkOKVmuKVkOKVnVxuLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cblxuLyoqXG4gKiBTZXRzIHVwIHRoZSBhcGlnd01hbmFnZW1lbnRBcGkgc2VydmljZVxuICogQHBhcmFtIHsqfSBldmVudFxuICogQHJldHVybnMgLSBhcGlnd01hbmFnZW1lbnRBcGkgc2VydmljZVxuICovXG5cbi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cbi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4vLyDilZTilabilZfilIzilIDilJDilIzilJDilIzilIzilIDilJDilIzilIDilJDilZTilabilZfilZTilZdcbi8vIOKVkeKVkeKVkeKUgiDilILilILilILilILilIIg4pSs4pSCIOKUgiDilZHilZHilaDilanilZdcbi8vIOKVqSDilanilJTilIDilJjilJjilJTilJjilJTilIDilJjilJTilIDilJjilZDilanilZ3ilZrilZDilZ1cbi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4vKlxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldE1vbmdvQ2xpZW50KCkge1xuICBjb25zdCBjb25maWcgPSBhd2FpdCBnZXRDb25maWcoKTtcbiAgaWYgKCFjb25maWcpIHRocm93IG5ldyBFcnJvcignQ29uZmlnIGNvdWxkIG5vdCBiZSByZXRyaWV2ZWQnKTtcbiAgY29uc3QgY2xpZW50ID0gYXdhaXQgY29ubmVjdE1vbmdvKDxzdHJpbmc+Y29uZmlnLm1vbmdvVVJJKTtcbiAgcmV0dXJuIGNsaWVudDtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldE1vbmdvREIoKTogUHJvbWlzZTxEYiB8IHVuZGVmaW5lZD4ge1xuICBjb25zdCBjb25maWcgPSBhd2FpdCBnZXRDb25maWcoKTtcbiAgY29uc3QgY2xpZW50ID0gYXdhaXQgZ2V0TW9uZ29DbGllbnQoKTtcbiAgY29uc3QgREIgPSBjbGllbnQ/LmRiKGNvbmZpZz8ubW9uZ29EQik7XG4gIHJldHVybiBEQjtcbn1cbiovXG4vLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG4vLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuLy8g4pWU4pWm4pWX4pSsIOKUrOKVlOKVkOKVl+KVlOKVkOKVlyDilaZcbi8vIOKVkeKVkeKVkeKUlOKUrOKUmOKVmuKVkOKVl+KVkeKVkOKVrOKVl+KVkVxuLy8g4pWpIOKVqSDilLQg4pWa4pWQ4pWd4pWa4pWQ4pWd4pWa4pWp4pWQ4pWdXG4vLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldE15U1FMQ2xpZW50KCk6IFByb21pc2U8bXlzcWwuQ29ubmVjdGlvbiB8IG51bGw+IHtcbiAgaWYgKE1ZU1FMKSByZXR1cm4gTVlTUUw7XG4gIGNvbnN0IGNvbmZpZyA9IGF3YWl0IGdldENvbmZpZygpO1xuICBpZiAoIWNvbmZpZyB8fCAhY29uZmlnLm15c3FsKSB0aHJvdyBuZXcgRXJyb3IoJ0NvbmZpZy9NeVNRTCBDb25maWcgY291bGQgbm90IGJlIHJldHJpZXZlZCcpO1xuICB0cnkge1xuICAgIE1ZU1FMID0gYXdhaXQgbXlzcWwuY3JlYXRlQ29ubmVjdGlvbihjb25maWcubXlzcWwpO1xuICAgIGF3YWl0IE1ZU1FMLmNvbm5lY3QoKTtcbiAgICByZXR1cm4gTVlTUUw7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignQ2Fubm90IGNvbm5lY3QgdG8gTXlTUUwgc2VydmVyICcsIGVycm9yKTtcbiAgfVxuICByZXR1cm4gbnVsbDtcbn1cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBkaXNjb25uZWN0TXlTUUwoKTogUHJvbWlzZTxib29sZWFuPiB7XG4gIGlmIChNWVNRTCAmJiBNWVNRTCkgYXdhaXQgTVlTUUwuZW5kKCk7XG4gIE1ZU1FMID0gbnVsbDtcbiAgcmV0dXJuIHRydWU7XG59XG5cbi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cbmV4cG9ydCBmdW5jdGlvbiByYW5kb21EYXRlKHN0YXJ0OiBEYXRlLCBlbmQ/OiBEYXRlKTogRGF0ZSB7XG4gIGVuZCA9IGVuZCB8fCBuZXcgRGF0ZSgpO1xuICByZXR1cm4gbmV3IERhdGUoc3RhcnQuZ2V0VGltZSgpICsgTWF0aC5yYW5kb20oKSAqIChlbmQuZ2V0VGltZSgpIC0gc3RhcnQuZ2V0VGltZSgpKSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiByYW5kb21JbnQobWluOiBudW1iZXIsIG1heDogbnVtYmVyKTogbnVtYmVyIHtcbiAgcmV0dXJuIGNyeXB0by5yYW5kb21JbnQobWluLCBtYXgpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gdHJ5UGFyc2UoanNvbjogc3RyaW5nKTogb2JqZWN0IHtcbiAgdHJ5IHtcbiAgICByZXR1cm4gSlNPTi5wYXJzZShqc29uKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIHJldHVybiB7fTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gbWludXRlc0Zyb21EdXJhdGlvbihkdXJhdGlvbjogc3RyaW5nKTogbnVtYmVyIHtcbiAgbGV0IHN0YWdlczogYW55O1xuICBpZiAoZHVyYXRpb24uaW5jbHVkZXMoJzonKSkge1xuICAgIHN0YWdlcyA9IGR1cmF0aW9uLnNwbGl0KCc6Jyk7XG4gICAgaWYgKHN0YWdlcy5sZW5ndGggPT0gMCkge1xuICAgICAgc3RhZ2VzID0gJzE6MDA6MDAnLnNwbGl0KCc6Jyk7XG4gICAgfSBlbHNlIGlmIChzdGFnZXMubGVuZ3RoID4gMikge1xuICAgICAgc3RhZ2VzID0gNjAgKiBzdGFnZXNbMF0gKyBzdGFnZXNbMV0gKiAxO1xuICAgIH0gZWxzZSBpZiAoKHN0YWdlcy5sZW5ndGggPSAyKSkge1xuICAgICAgc3RhZ2VzID0gMSAqIHN0YWdlc1swXTtcbiAgICB9XG5cbiAgICBpZiAoaXNOYU4oc3RhZ2VzKSB8fCBzdGFnZXMgPCAxMCkgc3RhZ2VzID0gNjA7XG4gIH0gZWxzZSB7XG4gICAgc3RhZ2VzID0gTnVtYmVyLnBhcnNlSW50KGR1cmF0aW9uKTtcbiAgICBpZiAoXy5pc05hTihzdGFnZXMpKSBzdGFnZXMgPSA2MDtcbiAgfVxuXG4gIHJldHVybiBzdGFnZXM7XG59XG5leHBvcnQgZnVuY3Rpb24gZGF5c0JldHdlZW4oZmlyc3REYXRlOiBEYXRlLCBzZWNvbmREYXRlOiBEYXRlKTogbnVtYmVyIHtcbiAgY29uc3Qgb25lRGF5ID0gMjQgKiA2MCAqIDYwICogMTAwMDsgLy8gaG91cnMqbWludXRlcypzZWNvbmRzKm1pbGxpc2Vjb25kc1xuICBjb25zdCBkaWZmRGF5cyA9IE1hdGgucm91bmQoTWF0aC5hYnMoKGZpcnN0RGF0ZS5nZXRUaW1lKCkgLSBzZWNvbmREYXRlLmdldFRpbWUoKSkgLyBvbmVEYXkpKTtcbiAgcmV0dXJuIGRpZmZEYXlzO1xufVxuZXhwb3J0IGZ1bmN0aW9uIHplcm9QYWQobnVtOiBudW1iZXIsIHBsYWNlczogbnVtYmVyKTogc3RyaW5nIHtcbiAgcmV0dXJuIFN0cmluZyhudW0pLnBhZFN0YXJ0KHBsYWNlcywgJzAnKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHV1aWR2NCgpIHtcbiAgcmV0dXJuICd4eHh4eHh4eC14eHh4LTR4eHgteXh4eC14eHh4eHh4eHh4eHgnLnJlcGxhY2UoL1t4eV0vZywgZnVuY3Rpb24gKGMpIHtcbiAgICB2YXIgciA9IChNYXRoLnJhbmRvbSgpICogMTYpIHwgMCxcbiAgICAgIHYgPSBjID09ICd4JyA/IHIgOiAociAmIDB4MykgfCAweDg7XG4gICAgcmV0dXJuIHYudG9TdHJpbmcoMTYpO1xuICB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGhhc0FsbEtleXMob2JqOiBvYmplY3QsIGtleXM6IHN0cmluZ1tdKTogYm9vbGVhbiB7XG4gIGxldCBoYXMgPSB0cnVlO1xuICBrZXlzLmZvckVhY2goKGs6IHN0cmluZykgPT4ge1xuICAgIGhhcyA9IGhhcyAmJiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwob2JqLCBrKTtcbiAgfSk7XG4gIHJldHVybiBoYXM7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzcGxpY2VTdHJpbmcoc3RyaW5nOiBzdHJpbmcsIGluZGV4OiBudW1iZXIsIGNvdW50OiBudW1iZXIgPSAwLCBpbnNlcnQ6IHN0cmluZyA9ICcnKTogc3RyaW5nIHtcbiAgY29uc3QgYXJyYXkgPSBfLnRvQXJyYXkoc3RyaW5nKTtcbiAgYXJyYXkuc3BsaWNlKGluZGV4LCBjb3VudCwgaW5zZXJ0KTtcbiAgcmV0dXJuIGFycmF5LmpvaW4oJycpO1xufVxuXG4vLyBodHRwczovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy84MTUyNDI2L2hvdy1jYW4taS1jYWxjdWxhdGUtdGhlLW51bWJlci1vZi15ZWFycy1iZXR3ZWVuLXR3by1kYXRlc1xuZXhwb3J0IGZ1bmN0aW9uIGNhbGN1bGF0ZUFnZShiaXJ0aGRheTogRGF0ZSk6IG51bWJlciB7XG4gIC8vIGJpcnRoZGF5IGlzIGEgZGF0ZVxuICB2YXIgYWdlRGlmTXMgPSBEYXRlLm5vdygpIC0gYmlydGhkYXkuZ2V0VGltZSgpO1xuICB2YXIgYWdlRGF0ZSA9IG5ldyBEYXRlKGFnZURpZk1zKTsgLy8gbWlsaXNlY29uZHMgZnJvbSBlcG9jaFxuICByZXR1cm4gTWF0aC5hYnMoYWdlRGF0ZS5nZXRVVENGdWxsWWVhcigpIC0gMTk3MCk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjdXJyZW50Q29uZmlnKCk6IFByb21pc2U8Q29uZmlnRGF0YSB8IG51bGw+IHtcbiAgbGV0IGNvbmZpZyA9IGF3YWl0IGdldENvbmZpZygpO1xuICByZXR1cm4gY29uZmlnO1xufVxuXG4vKipcbiAqIEdldCB0aGUgYXdzIHNvY2tldCBtYW5hZ2VyIHVzZWQgdG8gc2VuZCBtZXNzYWdlcyBvdmVyIGEgZ2l2ZW4gd2Vic29ja2V0IGdhdGV3YXlcbiAqIEBwYXJhbSBldmVudFxuICogQHJldHVybnNcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldE1nbXQoZXZlbnQ6IGFueSk6IEFXUy5BcGlHYXRld2F5TWFuYWdlbWVudEFwaSB7XG4gIGlmIChhcGlnd01hbmFnZW1lbnRBcGkpIHJldHVybiBhcGlnd01hbmFnZW1lbnRBcGk7XG4gIGFwaWd3TWFuYWdlbWVudEFwaSA9IG5ldyBBV1MuQXBpR2F0ZXdheU1hbmFnZW1lbnRBcGkoe1xuICAgIGFwaVZlcnNpb246ICcyMDE4LTExLTI5JyxcbiAgICBlbmRwb2ludDogZXZlbnQucmVxdWVzdENvbnRleHQuZG9tYWluTmFtZSArICcvJyArIGV2ZW50LnJlcXVlc3RDb250ZXh0LnN0YWdlLFxuICB9KTtcbiAgcmV0dXJuIGFwaWd3TWFuYWdlbWVudEFwaTtcbn1cblxuLyoqXG4gKiBTZW5kIGEgbWVzc2FnZSB0byBhIGdpdmVuIGNvbm5lY3Rpb25cbiAqIEBwYXJhbSB7c3RyaW5nfSB0b1xuICogQHBhcmFtIHtzdHJpbmd9IGFjdGlvblxuICogQHBhcmFtIHtvYmplY3R9IGRhdGFcbiAqIEByZXR1cm5zIGJvb2xlYW5cbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHNlbmRNZXNzYWdlKHRvOiBzdHJpbmcsIGFjdGlvbjogc3RyaW5nLCBkYXRhOiBhbnkpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgZGF0YS5hY3Rpb24gPSBhY3Rpb247XG4gIHRyeSB7XG4gICAgaWYgKGFwaWd3TWFuYWdlbWVudEFwaSkge1xuICAgICAgYXdhaXQgYXBpZ3dNYW5hZ2VtZW50QXBpXG4gICAgICAgIC5wb3N0VG9Db25uZWN0aW9uKHtcbiAgICAgICAgICBDb25uZWN0aW9uSWQ6IHRvLFxuICAgICAgICAgIERhdGE6IEpTT04uc3RyaW5naWZ5KGRhdGEpLFxuICAgICAgICB9KVxuICAgICAgICAucHJvbWlzZSgpO1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGNvbnNvbGUubG9nKCdFcnJvciBzZW5kaW5nIG1lc3NhZ2UgJywgZSk7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXREaXN0YW5jZUZyb21MYXRMb25JbkttKGxhdDE6IG51bWJlciwgbG9uMTogbnVtYmVyLCBsYXQyOiBudW1iZXIsIGxvbjI6IG51bWJlcik6IG51bWJlciB7XG4gIHZhciBSID0gNjM3MTsgLy8gUmFkaXVzIG9mIHRoZSBlYXJ0aCBpbiBrbVxuICB2YXIgZExhdCA9IGRlZzJyYWQobGF0MiAtIGxhdDEpOyAvLyBkZWcycmFkIGJlbG93XG4gIHZhciBkTG9uID0gZGVnMnJhZChsb24yIC0gbG9uMSk7XG4gIHZhciBhID1cbiAgICBNYXRoLnNpbihkTGF0IC8gMikgKiBNYXRoLnNpbihkTGF0IC8gMikgK1xuICAgIE1hdGguY29zKGRlZzJyYWQobGF0MSkpICogTWF0aC5jb3MoZGVnMnJhZChsYXQyKSkgKiBNYXRoLnNpbihkTG9uIC8gMikgKiBNYXRoLnNpbihkTG9uIC8gMik7XG4gIHZhciBjID0gMiAqIE1hdGguYXRhbjIoTWF0aC5zcXJ0KGEpLCBNYXRoLnNxcnQoMSAtIGEpKTtcbiAgdmFyIGQgPSBSICogYzsgLy8gRGlzdGFuY2UgaW4ga21cbiAgcmV0dXJuIGQ7XG59XG5cbmZ1bmN0aW9uIGRlZzJyYWQoZGVnOiBudW1iZXIpOiBudW1iZXIge1xuICByZXR1cm4gZGVnICogKE1hdGguUEkgLyAxODApO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZGVjb2RlQm9keShldmVudDogYW55KTogc3RyaW5nIHtcbiAgbGV0IGJvZHlSYXcgPSBldmVudC5ib2R5O1xuICBsZXQgYm9keTogc3RyaW5nID0gZXZlbnQuYm9keTtcbiAgbGV0IGJvZHlKU09OOiBhbnk7XG4gIGlmIChldmVudC5pc0Jhc2U2NEVuY29kZWQpIHtcbiAgICBib2R5ID0gQnVmZmVyLmZyb20oYm9keVJhdywgJ2Jhc2U2NCcpLnRvU3RyaW5nKCd1dGY4Jyk7XG4gIH1cbiAgdHJ5IHtcbiAgICBib2R5SlNPTiA9IEpTT04ucGFyc2UoYm9keSk7XG4gICAgcmV0dXJuIGJvZHlKU09OO1xuICB9IGNhdGNoIHtcbiAgICByZXR1cm4gYm9keTtcbiAgfVxufVxuZXhwb3J0IGZ1bmN0aW9uIG1vbnRoTmFtZShtb250aDogbnVtYmVyKTogc3RyaW5nIHtcbiAgbGV0IG1vbnRocyA9ICBbXCJKYW51YXJ5XCIsIFwiRmVicnVhcnlcIiwgXCJNYXJjaFwiLCBcIkFwcmlsXCIsIFwiTWF5XCIsIFwiSnVuZVwiLFwiSnVseVwiLCBcIkF1Z3VzdFwiLCBcIlNlcHRlbWJlclwiLCBcIk9jdG9iZXJcIiwgXCJOb3ZlbWJlclwiLCBcIkRlY2VtYmVyXCJdXG4gIGlmKG1vbnRoIDwgMCB8fCBtb250aCA+IDExKSB0aHJvdyBuZXcgRXJyb3IoXCJJbnZhbGlkIG1vbnRoIG51bWJlclwiKVxuICByZXR1cm4gbW9udGhzW21vbnRoXVxufVxuXG5leHBvcnQgZnVuY3Rpb24gc2hvcnRNb250aE5hbWUobW9udGg6IG51bWJlcik6IHN0cmluZyB7XG4gIHJldHVybiBtb250aE5hbWUobW9udGgpLnN1YnN0cmluZygwLDMpLnRvVXBwZXJDYXNlKCk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpbmplY3REYXRlKHRleHQ6IHN0cmluZyk6IHN0cmluZyB7XG4gIGZ1bmN0aW9uIHBhZChuOiBudW1iZXIpOiBzdHJpbmcge1xuICAgIHJldHVybiBuIDwgMTAgPyAnMCcgKyBuIDogJycgKyBuO1xuICB9XG4gIGxldCB0aW1lTm93ID0gbmV3IERhdGUoKTtcbiAgdGV4dCA9IHRleHQucmVwbGFjZSgvJXNtL2csIHNob3J0TW9udGhOYW1lKHRpbWVOb3cuZ2V0TW9udGgoKSkpO1xuICB0ZXh0ID0gdGV4dC5yZXBsYWNlKC8lbG0vZywgbW9udGhOYW1lKHRpbWVOb3cuZ2V0TW9udGgoKSkpO1xuICB0ZXh0ID0gdGV4dC5yZXBsYWNlKC8lZC9nLCBwYWQodGltZU5vdy5nZXREYXRlKCkpKTtcbiAgdGV4dCA9IHRleHQucmVwbGFjZSgvJW0vZywgcGFkKHRpbWVOb3cuZ2V0TW9udGgoKSsxKSk7XG4gIHRleHQgPSB0ZXh0LnJlcGxhY2UoLyV5L2csIHBhZCh0aW1lTm93LmdldEZ1bGxZZWFyKCkpKTtcbiAgdGV4dCA9IHRleHQucmVwbGFjZSgvJWgvZywgcGFkKHRpbWVOb3cuZ2V0SG91cnMoKSkpO1xuICB0ZXh0ID0gdGV4dC5yZXBsYWNlKC8lbi9nLCBwYWQodGltZU5vdy5nZXRNaW51dGVzKCkpKTtcbiAgdGV4dCA9IHRleHQucmVwbGFjZSgvJXMvZywgcGFkKHRpbWVOb3cuZ2V0U2Vjb25kcygpKSk7XG4gIHRleHQgPSB0ZXh0LnJlcGxhY2UoLyVsL2csIHBhZCh0aW1lTm93LmdldE1pbGxpc2Vjb25kcygpKSk7XG5cbiAgcmV0dXJuIHRleHQ7XG59XG5cbmV4cG9ydCB7Z2V0Q29uZmlnfTtcbiJdfQ==