"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.getConfig = exports.injectDate = exports.shortMonthName = exports.monthName = exports.decodeBody = exports.getDistanceFromLatLonInKm = exports.sendMessage = exports.getMgmt = exports.currentConfig = exports.calculateAge = exports.spliceString = exports.hasAllKeys = exports.uuidv4 = exports.zeroPad = exports.daysBetween = exports.minutesFromDuration = exports.tryParse = exports.randomInt = exports.randomDate = exports.disconnectMySQL = exports.getMySQLClient = exports.lambda = void 0;
const AWS = __importStar(require("aws-sdk"));
const _ = __importStar(require("lodash"));
const crypto = __importStar(require("crypto"));
const getConfig_1 = require("./getConfig");
Object.defineProperty(exports, "getConfig", { enumerable: true, get: function () { return getConfig_1.getConfig; } });
const mysql = __importStar(require("mysql2/promise"));
let apigwManagementApi = null;
exports.lambda = new AWS.Lambda();
let MYSQL = null;
async function getMySQLClient() {
    if (MYSQL)
        return MYSQL;
    const config = await (0, getConfig_1.getConfig)();
    if (!config || !config.mysql)
        throw new Error('Config/MySQL Config could not be retrieved');
    try {
        MYSQL = await mysql.createConnection(config.mysql);
        await MYSQL.connect();
        return MYSQL;
    }
    catch (error) {
        console.error('Cannot connect to MySQL server ', error);
    }
    return null;
}
exports.getMySQLClient = getMySQLClient;
async function disconnectMySQL() {
    if (MYSQL && MYSQL)
        await MYSQL.end();
    MYSQL = null;
    return true;
}
exports.disconnectMySQL = disconnectMySQL;
function randomDate(start, end) {
    end = end || new Date();
    return new Date(start.getTime() + Math.random() * (end.getTime() - start.getTime()));
}
exports.randomDate = randomDate;
function randomInt(min, max) {
    return crypto.randomInt(min, max);
}
exports.randomInt = randomInt;
function tryParse(json) {
    try {
        return JSON.parse(json);
    }
    catch (e) {
        return {};
    }
}
exports.tryParse = tryParse;
function minutesFromDuration(duration) {
    let stages;
    if (duration.includes(':')) {
        stages = duration.split(':');
        if (stages.length == 0) {
            stages = '1:00:00'.split(':');
        }
        else if (stages.length > 2) {
            stages = 60 * stages[0] + stages[1] * 1;
        }
        else if ((stages.length = 2)) {
            stages = 1 * stages[0];
        }
        if (isNaN(stages) || stages < 10)
            stages = 60;
    }
    else {
        stages = Number.parseInt(duration);
        if (_.isNaN(stages))
            stages = 60;
    }
    return stages;
}
exports.minutesFromDuration = minutesFromDuration;
function daysBetween(firstDate, secondDate) {
    const oneDay = 24 * 60 * 60 * 1000;
    const diffDays = Math.round(Math.abs((firstDate.getTime() - secondDate.getTime()) / oneDay));
    return diffDays;
}
exports.daysBetween = daysBetween;
function zeroPad(num, places) {
    return String(num).padStart(places, '0');
}
exports.zeroPad = zeroPad;
function uuidv4() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
        var r = (Math.random() * 16) | 0, v = c == 'x' ? r : (r & 0x3) | 0x8;
        return v.toString(16);
    });
}
exports.uuidv4 = uuidv4;
function hasAllKeys(obj, keys) {
    let has = true;
    keys.forEach((k) => {
        has = has && Object.prototype.hasOwnProperty.call(obj, k);
    });
    return has;
}
exports.hasAllKeys = hasAllKeys;
function spliceString(string, index, count = 0, insert = '') {
    const array = _.toArray(string);
    array.splice(index, count, insert);
    return array.join('');
}
exports.spliceString = spliceString;
function calculateAge(birthday) {
    var ageDifMs = Date.now() - birthday.getTime();
    var ageDate = new Date(ageDifMs);
    return Math.abs(ageDate.getUTCFullYear() - 1970);
}
exports.calculateAge = calculateAge;
async function currentConfig() {
    let config = await (0, getConfig_1.getConfig)();
    return config;
}
exports.currentConfig = currentConfig;
function getMgmt(event) {
    if (apigwManagementApi)
        return apigwManagementApi;
    apigwManagementApi = new AWS.ApiGatewayManagementApi({
        apiVersion: '2018-11-29',
        endpoint: event.requestContext.domainName + '/' + event.requestContext.stage,
    });
    return apigwManagementApi;
}
exports.getMgmt = getMgmt;
async function sendMessage(to, action, data) {
    data.action = action;
    try {
        if (apigwManagementApi) {
            await apigwManagementApi
                .postToConnection({
                ConnectionId: to,
                Data: JSON.stringify(data),
            })
                .promise();
            return true;
        }
        return false;
    }
    catch (e) {
        console.log('Error sending message ', e);
        return false;
    }
}
exports.sendMessage = sendMessage;
function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
    var R = 6371;
    var dLat = deg2rad(lat2 - lat1);
    var dLon = deg2rad(lon2 - lon1);
    var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    var d = R * c;
    return d;
}
exports.getDistanceFromLatLonInKm = getDistanceFromLatLonInKm;
function deg2rad(deg) {
    return deg * (Math.PI / 180);
}
function decodeBody(event) {
    let bodyRaw = event.body;
    let body = '';
    let bodyJSON;
    if (event.isBase64Encoded) {
        body = Buffer.from(bodyRaw, 'base64').toString('utf8');
    }
    try {
        bodyJSON = JSON.parse(body);
        return bodyJSON;
    }
    catch (_a) {
        return body;
    }
}
exports.decodeBody = decodeBody;
function monthName(month) {
    let months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    if (month < 0 || month > 11)
        throw new Error("Invalid month number");
    return months[month];
}
exports.monthName = monthName;
function shortMonthName(month) {
    return monthName(month).substring(0, 3).toUpperCase();
}
exports.shortMonthName = shortMonthName;
function injectDate(text) {
    function pad(n) {
        return n < 10 ? '0' + n : '' + n;
    }
    let timeNow = new Date();
    text = text.replace(/%sm/g, shortMonthName(timeNow.getMonth()));
    text = text.replace(/%lm/g, monthName(timeNow.getMonth()));
    text = text.replace(/%d/g, pad(timeNow.getDate()));
    text = text.replace(/%m/g, pad(timeNow.getMonth() + 1));
    text = text.replace(/%y/g, pad(timeNow.getFullYear()));
    text = text.replace(/%h/g, pad(timeNow.getHours()));
    text = text.replace(/%n/g, pad(timeNow.getMinutes()));
    text = text.replace(/%s/g, pad(timeNow.getSeconds()));
    text = text.replace(/%l/g, pad(timeNow.getMilliseconds()));
    return text;
}
exports.injectDate = injectDate;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGVscGVycy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImhlbHBlcnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDZDQUErQjtBQUMvQiwwQ0FBNEI7QUFDNUIsK0NBQWlDO0FBRWpDLDJDQUFrRDtBQWlRMUMsMEZBalFZLHFCQUFTLE9BaVFaO0FBOVBqQixzREFBd0M7QUFDeEMsSUFBSSxrQkFBa0IsR0FBdUMsSUFBSSxDQUFDO0FBU3JELFFBQUEsTUFBTSxHQUFHLElBQUksR0FBRyxDQUFDLE1BQU0sRUFBRSxDQUFDO0FBRXZDLElBQUksS0FBSyxHQUE0QixJQUFJLENBQUM7QUEwQ25DLEtBQUssVUFBVSxjQUFjO0lBQ2xDLElBQUksS0FBSztRQUFFLE9BQU8sS0FBSyxDQUFDO0lBQ3hCLE1BQU0sTUFBTSxHQUFHLE1BQU0sSUFBQSxxQkFBUyxHQUFFLENBQUM7SUFDakMsSUFBSSxDQUFDLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLO1FBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyw0Q0FBNEMsQ0FBQyxDQUFDO0lBQzVGLElBQUk7UUFDRixLQUFLLEdBQUcsTUFBTSxLQUFLLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ25ELE1BQU0sS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQ3RCLE9BQU8sS0FBSyxDQUFDO0tBQ2Q7SUFBQyxPQUFPLEtBQUssRUFBRTtRQUNkLE9BQU8sQ0FBQyxLQUFLLENBQUMsaUNBQWlDLEVBQUUsS0FBSyxDQUFDLENBQUM7S0FDekQ7SUFDRCxPQUFPLElBQUksQ0FBQztBQUNkLENBQUM7QUFaRCx3Q0FZQztBQUNNLEtBQUssVUFBVSxlQUFlO0lBQ25DLElBQUksS0FBSyxJQUFJLEtBQUs7UUFBRSxNQUFNLEtBQUssQ0FBQyxHQUFHLEVBQUUsQ0FBQztJQUN0QyxLQUFLLEdBQUcsSUFBSSxDQUFDO0lBQ2IsT0FBTyxJQUFJ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QUFDO0lBQ0QsSUFBSSxPQUFPLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQztJQUN6QixJQUFJLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsY0FBYyxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDaEUsSUFBSSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLFNBQVMsQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQzNELElBQUksR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsQ0FBQztJQUNuRCxJQUFJLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUUsR0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3RELElBQUksR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsT0FBTyxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUN2RCxJQUFJLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDcEQsSUFBSSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxPQUFPLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQ3RELElBQUksR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsT0FBTyxDQUFDLFVBQVUsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUN0RCxJQUFJLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLE9BQU8sQ0FBQyxlQUFlLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFFM0QsT0FBTyxJQUFJLENBQUM7QUFDZCxDQUFDO0FBaEJELGdDQWdCQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIEFXUyBmcm9tICdhd3Mtc2RrJztcbmltcG9ydCAqIGFzIF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCAqIGFzIGNyeXB0byBmcm9tICdjcnlwdG8nO1xuLy8gaW1wb3J0ICogYXMgc2VjcmV0cyBmcm9tICcuLy5zZWNyZXRzLmpzb24nO1xuaW1wb3J0IHtDb25maWdEYXRhLCBnZXRDb25maWd9IGZyb20gJy4vZ2V0Q29uZmlnJztcbi8vIGltcG9ydCB7T2JqZWN0SWQsIGNvbm5lY3RNb25nbywgU3RvcmVUeXBlfSBmcm9tICcuL2dldE1vbmdvQ2xpZW50Jztcbi8vIGltcG9ydCB7RGJ9IGZyb20gJ21vbmdvZGInO1xuaW1wb3J0ICogYXMgbXlzcWwgZnJvbSAnbXlzcWwyL3Byb21pc2UnO1xubGV0IGFwaWd3TWFuYWdlbWVudEFwaTogQVdTLkFwaUdhdGV3YXlNYW5hZ2VtZW50QXBpIHwgbnVsbCA9IG51bGw7XG4vLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuLy8g8J+Tm/Cfk5vwn5Ob8J+Tm/Cfk5vwn5Ob8J+Tm/Cfk5vwn5Ob8J+Tm/Cfk5vwn5Ob8J+Tm/Cfk5vwn5Ob8J+Tm/Cfk5vwn5Ob8J+Tm/Cfk5vwn5Ob8J+Tm/Cfk5vwn5Ob8J+Tm/Cfk5vwn5Ob8J+Tm/Cfk5vwn5ObXG4vLyBSRU1PVkUgZHluYW1vQ29uZmlnIGJlZm9yZSBnb2luZyBsaXZlXG4vLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuLy8gZXhwb3J0IGNvbnN0IGxhbWJkYSA9IG5ldyBBV1MuTGFtYmRhKHNlY3JldHMpO1xuLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbi8vIPCfk5vwn5Ob8J+Tm/Cfk5vwn5Ob8J+Tm/Cfk5vwn5Ob8J+Tm/Cfk5vwn5Ob8J+Tm/Cfk5vwn5Ob8J+Tm/Cfk5vwn5Ob8J+Tm/Cfk5vwn5Ob8J+Tm/Cfk5vwn5Ob8J+Tm/Cfk5vwn5Ob8J+Tm/Cfk5vwn5Ob8J+Tm1xuLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbmV4cG9ydCBjb25zdCBsYW1iZGEgPSBuZXcgQVdTLkxhbWJkYSgpO1xuLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbmxldCBNWVNRTDogbXlzcWwuQ29ubmVjdGlvbiB8IG51bGwgPSBudWxsO1xuLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbi8vIOKVpiDilabilZTilZDilZfilaYgIOKVlOKVkOKVl+KVlOKVkOKVl+KVpuKVkOKVl+KVlOKVkOKVl1xuLy8g4pWg4pWQ4pWj4pWR4pWjIOKVkSAg4pWg4pWQ4pWd4pWR4pWjIOKVoOKVpuKVneKVmuKVkOKVl1xuLy8g4pWpIOKVqeKVmuKVkOKVneKVqeKVkOKVneKVqSAg4pWa4pWQ4pWd4pWp4pWa4pWQ4pWa4pWQ4pWdXG4vLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG4vKipcbiAqIFNldHMgdXAgdGhlIGFwaWd3TWFuYWdlbWVudEFwaSBzZXJ2aWNlXG4gKiBAcGFyYW0geyp9IGV2ZW50XG4gKiBAcmV0dXJucyAtIGFwaWd3TWFuYWdlbWVudEFwaSBzZXJ2aWNlXG4gKi9cblxuLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cblxuLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbi8vIOKVlOKVpuKVl+KUjOKUgOKUkOKUjOKUkOKUjOKUjOKUgOKUkOKUjOKUgOKUkOKVlOKVpuKVl+KVlOKVl1xuLy8g4pWR4pWR4pWR4pSCIOKUguKUguKUguKUguKUgiDilKzilIIg4pSCIOKVkeKVkeKVoOKVqeKVl1xuLy8g4pWpIOKVqeKUlOKUgOKUmOKUmOKUlOKUmOKUlOKUgOKUmOKUlOKUgOKUmOKVkOKVqeKVneKVmuKVkOKVnVxuLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbi8qXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0TW9uZ29DbGllbnQoKSB7XG4gIGNvbnN0IGNvbmZpZyA9IGF3YWl0IGdldENvbmZpZygpO1xuICBpZiAoIWNvbmZpZykgdGhyb3cgbmV3IEVycm9yKCdDb25maWcgY291bGQgbm90IGJlIHJldHJpZXZlZCcpO1xuICBjb25zdCBjbGllbnQgPSBhd2FpdCBjb25uZWN0TW9uZ28oPHN0cmluZz5jb25maWcubW9uZ29VUkkpO1xuICByZXR1cm4gY2xpZW50O1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0TW9uZ29EQigpOiBQcm9taXNlPERiIHwgdW5kZWZpbmVkPiB7XG4gIGNvbnN0IGNvbmZpZyA9IGF3YWl0IGdldENvbmZpZygpO1xuICBjb25zdCBjbGllbnQgPSBhd2FpdCBnZXRNb25nb0NsaWVudCgpO1xuICBjb25zdCBEQiA9IGNsaWVudD8uZGIoY29uZmlnPy5tb25nb0RCKTtcbiAgcmV0dXJuIERCO1xufVxuKi9cbi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cbi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4vLyDilZTilabilZfilKwg4pSs4pWU4pWQ4pWX4pWU4pWQ4pWXIOKVplxuLy8g4pWR4pWR4pWR4pSU4pSs4pSY4pWa4pWQ4pWX4pWR4pWQ4pWs4pWX4pWRXG4vLyDilakg4pWpIOKUtCDilZrilZDilZ3ilZrilZDilZ3ilZrilanilZDilZ1cbi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0TXlTUUxDbGllbnQoKTogUHJvbWlzZTxteXNxbC5Db25uZWN0aW9uIHwgbnVsbD4ge1xuICBpZiAoTVlTUUwpIHJldHVybiBNWVNRTDtcbiAgY29uc3QgY29uZmlnID0gYXdhaXQgZ2V0Q29uZmlnKCk7XG4gIGlmICghY29uZmlnIHx8ICFjb25maWcubXlzcWwpIHRocm93IG5ldyBFcnJvcignQ29uZmlnL015U1FMIENvbmZpZyBjb3VsZCBub3QgYmUgcmV0cmlldmVkJyk7XG4gIHRyeSB7XG4gICAgTVlTUUwgPSBhd2FpdCBteXNxbC5jcmVhdGVDb25uZWN0aW9uKGNvbmZpZy5teXNxbCk7XG4gICAgYXdhaXQgTVlTUUwuY29ubmVjdCgpO1xuICAgIHJldHVybiBNWVNRTDtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdDYW5ub3QgY29ubmVjdCB0byBNeVNRTCBzZXJ2ZXIgJywgZXJyb3IpO1xuICB9XG4gIHJldHVybiBudWxsO1xufVxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGRpc2Nvbm5lY3RNeVNRTCgpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgaWYgKE1ZU1FMICYmIE1ZU1FMKSBhd2FpdCBNWVNRTC5lbmQoKTtcbiAgTVlTUUwgPSBudWxsO1xuICByZXR1cm4gdHJ1ZTtcbn1cblxuLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cblxuZXhwb3J0IGZ1bmN0aW9uIHJhbmRvbURhdGUoc3RhcnQ6IERhdGUsIGVuZD86IERhdGUpOiBEYXRlIHtcbiAgZW5kID0gZW5kIHx8IG5ldyBEYXRlKCk7XG4gIHJldHVybiBuZXcgRGF0ZShzdGFydC5nZXRUaW1lKCkgKyBNYXRoLnJhbmRvbSgpICogKGVuZC5nZXRUaW1lKCkgLSBzdGFydC5nZXRUaW1lKCkpKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJhbmRvbUludChtaW46IG51bWJlciwgbWF4OiBudW1iZXIpOiBudW1iZXIge1xuICByZXR1cm4gY3J5cHRvLnJhbmRvbUludChtaW4sIG1heCk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB0cnlQYXJzZShqc29uOiBzdHJpbmcpOiBvYmplY3Qge1xuICB0cnkge1xuICAgIHJldHVybiBKU09OLnBhcnNlKGpzb24pO1xuICB9IGNhdGNoIChlKSB7XG4gICAgcmV0dXJuIHt9O1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBtaW51dGVzRnJvbUR1cmF0aW9uKGR1cmF0aW9uOiBzdHJpbmcpOiBudW1iZXIge1xuICBsZXQgc3RhZ2VzOiBhbnk7XG4gIGlmIChkdXJhdGlvbi5pbmNsdWRlcygnOicpKSB7XG4gICAgc3RhZ2VzID0gZHVyYXRpb24uc3BsaXQoJzonKTtcbiAgICBpZiAoc3RhZ2VzLmxlbmd0aCA9PSAwKSB7XG4gICAgICBzdGFnZXMgPSAnMTowMDowMCcuc3BsaXQoJzonKTtcbiAgICB9IGVsc2UgaWYgKHN0YWdlcy5sZW5ndGggPiAyKSB7XG4gICAgICBzdGFnZXMgPSA2MCAqIHN0YWdlc1swXSArIHN0YWdlc1sxXSAqIDE7XG4gICAgfSBlbHNlIGlmICgoc3RhZ2VzLmxlbmd0aCA9IDIpKSB7XG4gICAgICBzdGFnZXMgPSAxICogc3RhZ2VzWzBdO1xuICAgIH1cblxuICAgIGlmIChpc05hTihzdGFnZXMpIHx8IHN0YWdlcyA8IDEwKSBzdGFnZXMgPSA2MDtcbiAgfSBlbHNlIHtcbiAgICBzdGFnZXMgPSBOdW1iZXIucGFyc2VJbnQoZHVyYXRpb24pO1xuICAgIGlmIChfLmlzTmFOKHN0YWdlcykpIHN0YWdlcyA9IDYwO1xuICB9XG5cbiAgcmV0dXJuIHN0YWdlcztcbn1cbmV4cG9ydCBmdW5jdGlvbiBkYXlzQmV0d2VlbihmaXJzdERhdGU6IERhdGUsIHNlY29uZERhdGU6IERhdGUpOiBudW1iZXIge1xuICBjb25zdCBvbmVEYXkgPSAyNCAqIDYwICogNjAgKiAxMDAwOyAvLyBob3VycyptaW51dGVzKnNlY29uZHMqbWlsbGlzZWNvbmRzXG4gIGNvbnN0IGRpZmZEYXlzID0gTWF0aC5yb3VuZChNYXRoLmFicygoZmlyc3REYXRlLmdldFRpbWUoKSAtIHNlY29uZERhdGUuZ2V0VGltZSgpKSAvIG9uZURheSkpO1xuICByZXR1cm4gZGlmZkRheXM7XG59XG5leHBvcnQgZnVuY3Rpb24gemVyb1BhZChudW06IG51bWJlciwgcGxhY2VzOiBudW1iZXIpOiBzdHJpbmcge1xuICByZXR1cm4gU3RyaW5nKG51bSkucGFkU3RhcnQocGxhY2VzLCAnMCcpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gdXVpZHY0KCkge1xuICByZXR1cm4gJ3h4eHh4eHh4LXh4eHgtNHh4eC15eHh4LXh4eHh4eHh4eHh4eCcucmVwbGFjZSgvW3h5XS9nLCBmdW5jdGlvbiAoYykge1xuICAgIHZhciByID0gKE1hdGgucmFuZG9tKCkgKiAxNikgfCAwLFxuICAgICAgdiA9IGMgPT0gJ3gnID8gciA6IChyICYgMHgzKSB8IDB4ODtcbiAgICByZXR1cm4gdi50b1N0cmluZygxNik7XG4gIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaGFzQWxsS2V5cyhvYmo6IG9iamVjdCwga2V5czogc3RyaW5nW10pOiBib29sZWFuIHtcbiAgbGV0IGhhcyA9IHRydWU7XG4gIGtleXMuZm9yRWFjaCgoazogc3RyaW5nKSA9PiB7XG4gICAgaGFzID0gaGFzICYmIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmosIGspO1xuICB9KTtcbiAgcmV0dXJuIGhhcztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNwbGljZVN0cmluZyhzdHJpbmc6IHN0cmluZywgaW5kZXg6IG51bWJlciwgY291bnQ6IG51bWJlciA9IDAsIGluc2VydDogc3RyaW5nID0gJycpOiBzdHJpbmcge1xuICBjb25zdCBhcnJheSA9IF8udG9BcnJheShzdHJpbmcpO1xuICBhcnJheS5zcGxpY2UoaW5kZXgsIGNvdW50LCBpbnNlcnQpO1xuICByZXR1cm4gYXJyYXkuam9pbignJyk7XG59XG5cbi8vIGh0dHBzOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzgxNTI0MjYvaG93LWNhbi1pLWNhbGN1bGF0ZS10aGUtbnVtYmVyLW9mLXllYXJzLWJldHdlZW4tdHdvLWRhdGVzXG5leHBvcnQgZnVuY3Rpb24gY2FsY3VsYXRlQWdlKGJpcnRoZGF5OiBEYXRlKTogbnVtYmVyIHtcbiAgLy8gYmlydGhkYXkgaXMgYSBkYXRlXG4gIHZhciBhZ2VEaWZNcyA9IERhdGUubm93KCkgLSBiaXJ0aGRheS5nZXRUaW1lKCk7XG4gIHZhciBhZ2VEYXRlID0gbmV3IERhdGUoYWdlRGlmTXMpOyAvLyBtaWxpc2Vjb25kcyBmcm9tIGVwb2NoXG4gIHJldHVybiBNYXRoLmFicyhhZ2VEYXRlLmdldFVUQ0Z1bGxZZWFyKCkgLSAxOTcwKTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGN1cnJlbnRDb25maWcoKTogUHJvbWlzZTxDb25maWdEYXRhIHwgbnVsbD4ge1xuICBsZXQgY29uZmlnID0gYXdhaXQgZ2V0Q29uZmlnKCk7XG4gIHJldHVybiBjb25maWc7XG59XG5cbi8qKlxuICogR2V0IHRoZSBhd3Mgc29ja2V0IG1hbmFnZXIgdXNlZCB0byBzZW5kIG1lc3NhZ2VzIG92ZXIgYSBnaXZlbiB3ZWJzb2NrZXQgZ2F0ZXdheVxuICogQHBhcmFtIGV2ZW50XG4gKiBAcmV0dXJuc1xuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0TWdtdChldmVudDogYW55KTogQVdTLkFwaUdhdGV3YXlNYW5hZ2VtZW50QXBpIHtcbiAgaWYgKGFwaWd3TWFuYWdlbWVudEFwaSkgcmV0dXJuIGFwaWd3TWFuYWdlbWVudEFwaTtcbiAgYXBpZ3dNYW5hZ2VtZW50QXBpID0gbmV3IEFXUy5BcGlHYXRld2F5TWFuYWdlbWVudEFwaSh7XG4gICAgYXBpVmVyc2lvbjogJzIwMTgtMTEtMjknLFxuICAgIGVuZHBvaW50OiBldmVudC5yZXF1ZXN0Q29udGV4dC5kb21haW5OYW1lICsgJy8nICsgZXZlbnQucmVxdWVzdENvbnRleHQuc3RhZ2UsXG4gIH0pO1xuICByZXR1cm4gYXBpZ3dNYW5hZ2VtZW50QXBpO1xufVxuXG4vKipcbiAqIFNlbmQgYSBtZXNzYWdlIHRvIGEgZ2l2ZW4gY29ubmVjdGlvblxuICogQHBhcmFtIHtzdHJpbmd9IHRvXG4gKiBAcGFyYW0ge3N0cmluZ30gYWN0aW9uXG4gKiBAcGFyYW0ge29iamVjdH0gZGF0YVxuICogQHJldHVybnMgYm9vbGVhblxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gc2VuZE1lc3NhZ2UodG86IHN0cmluZywgYWN0aW9uOiBzdHJpbmcsIGRhdGE6IGFueSk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICBkYXRhLmFjdGlvbiA9IGFjdGlvbjtcbiAgdHJ5IHtcbiAgICBpZiAoYXBpZ3dNYW5hZ2VtZW50QXBpKSB7XG4gICAgICBhd2FpdCBhcGlnd01hbmFnZW1lbnRBcGlcbiAgICAgICAgLnBvc3RUb0Nvbm5lY3Rpb24oe1xuICAgICAgICAgIENvbm5lY3Rpb25JZDogdG8sXG4gICAgICAgICAgRGF0YTogSlNPTi5zdHJpbmdpZnkoZGF0YSksXG4gICAgICAgIH0pXG4gICAgICAgIC5wcm9taXNlKCk7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9IGNhdGNoIChlKSB7XG4gICAgY29uc29sZS5sb2coJ0Vycm9yIHNlbmRpbmcgbWVzc2FnZSAnLCBlKTtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldERpc3RhbmNlRnJvbUxhdExvbkluS20obGF0MTogbnVtYmVyLCBsb24xOiBudW1iZXIsIGxhdDI6IG51bWJlciwgbG9uMjogbnVtYmVyKTogbnVtYmVyIHtcbiAgdmFyIFIgPSA2MzcxOyAvLyBSYWRpdXMgb2YgdGhlIGVhcnRoIGluIGttXG4gIHZhciBkTGF0ID0gZGVnMnJhZChsYXQyIC0gbGF0MSk7IC8vIGRlZzJyYWQgYmVsb3dcbiAgdmFyIGRMb24gPSBkZWcycmFkKGxvbjIgLSBsb24xKTtcbiAgdmFyIGEgPVxuICAgIE1hdGguc2luKGRMYXQgLyAyKSAqIE1hdGguc2luKGRMYXQgLyAyKSArXG4gICAgTWF0aC5jb3MoZGVnMnJhZChsYXQxKSkgKiBNYXRoLmNvcyhkZWcycmFkKGxhdDIpKSAqIE1hdGguc2luKGRMb24gLyAyKSAqIE1hdGguc2luKGRMb24gLyAyKTtcbiAgdmFyIGMgPSAyICogTWF0aC5hdGFuMihNYXRoLnNxcnQoYSksIE1hdGguc3FydCgxIC0gYSkpO1xuICB2YXIgZCA9IFIgKiBjOyAvLyBEaXN0YW5jZSBpbiBrbVxuICByZXR1cm4gZDtcbn1cblxuZnVuY3Rpb24gZGVnMnJhZChkZWc6IG51bWJlcik6IG51bWJlciB7XG4gIHJldHVybiBkZWcgKiAoTWF0aC5QSSAvIDE4MCk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBkZWNvZGVCb2R5KGV2ZW50OiBhbnkpOiBzdHJpbmcge1xuICBsZXQgYm9keVJhdyA9IGV2ZW50LmJvZHk7XG4gIGxldCBib2R5OiBzdHJpbmcgPSAnJztcbiAgbGV0IGJvZHlKU09OOiBhbnk7XG4gIGlmIChldmVudC5pc0Jhc2U2NEVuY29kZWQpIHtcbiAgICBib2R5ID0gQnVmZmVyLmZyb20oYm9keVJhdywgJ2Jhc2U2NCcpLnRvU3RyaW5nKCd1dGY4Jyk7XG4gIH1cbiAgdHJ5IHtcbiAgICBib2R5SlNPTiA9IEpTT04ucGFyc2UoYm9keSk7XG4gICAgcmV0dXJuIGJvZHlKU09OO1xuICB9IGNhdGNoIHtcbiAgICByZXR1cm4gYm9keTtcbiAgfVxufVxuZXhwb3J0IGZ1bmN0aW9uIG1vbnRoTmFtZShtb250aDogbnVtYmVyKTogc3RyaW5nIHtcbiAgbGV0IG1vbnRocyA9ICBbXCJKYW51YXJ5XCIsIFwiRmVicnVhcnlcIiwgXCJNYXJjaFwiLCBcIkFwcmlsXCIsIFwiTWF5XCIsIFwiSnVuZVwiLFwiSnVseVwiLCBcIkF1Z3VzdFwiLCBcIlNlcHRlbWJlclwiLCBcIk9jdG9iZXJcIiwgXCJOb3ZlbWJlclwiLCBcIkRlY2VtYmVyXCJdXG4gIGlmKG1vbnRoIDwgMCB8fCBtb250aCA+IDExKSB0aHJvdyBuZXcgRXJyb3IoXCJJbnZhbGlkIG1vbnRoIG51bWJlclwiKVxuICByZXR1cm4gbW9udGhzW21vbnRoXVxufVxuXG5leHBvcnQgZnVuY3Rpb24gc2hvcnRNb250aE5hbWUobW9udGg6IG51bWJlcik6IHN0cmluZyB7XG4gIHJldHVybiBtb250aE5hbWUobW9udGgpLnN1YnN0cmluZygwLDMpLnRvVXBwZXJDYXNlKCk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpbmplY3REYXRlKHRleHQ6IHN0cmluZyk6IHN0cmluZyB7XG4gIGZ1bmN0aW9uIHBhZChuOiBudW1iZXIpOiBzdHJpbmcge1xuICAgIHJldHVybiBuIDwgMTAgPyAnMCcgKyBuIDogJycgKyBuO1xuICB9XG4gIGxldCB0aW1lTm93ID0gbmV3IERhdGUoKTtcbiAgdGV4dCA9IHRleHQucmVwbGFjZSgvJXNtL2csIHNob3J0TW9udGhOYW1lKHRpbWVOb3cuZ2V0TW9udGgoKSkpO1xuICB0ZXh0ID0gdGV4dC5yZXBsYWNlKC8lbG0vZywgbW9udGhOYW1lKHRpbWVOb3cuZ2V0TW9udGgoKSkpO1xuICB0ZXh0ID0gdGV4dC5yZXBsYWNlKC8lZC9nLCBwYWQodGltZU5vdy5nZXREYXRlKCkpKTtcbiAgdGV4dCA9IHRleHQucmVwbGFjZSgvJW0vZywgcGFkKHRpbWVOb3cuZ2V0TW9udGgoKSsxKSk7XG4gIHRleHQgPSB0ZXh0LnJlcGxhY2UoLyV5L2csIHBhZCh0aW1lTm93LmdldEZ1bGxZZWFyKCkpKTtcbiAgdGV4dCA9IHRleHQucmVwbGFjZSgvJWgvZywgcGFkKHRpbWVOb3cuZ2V0SG91cnMoKSkpO1xuICB0ZXh0ID0gdGV4dC5yZXBsYWNlKC8lbi9nLCBwYWQodGltZU5vdy5nZXRNaW51dGVzKCkpKTtcbiAgdGV4dCA9IHRleHQucmVwbGFjZSgvJXMvZywgcGFkKHRpbWVOb3cuZ2V0U2Vjb25kcygpKSk7XG4gIHRleHQgPSB0ZXh0LnJlcGxhY2UoLyVsL2csIHBhZCh0aW1lTm93LmdldE1pbGxpc2Vjb25kcygpKSk7XG5cbiAgcmV0dXJuIHRleHQ7XG59XG5cbmV4cG9ydCB7Z2V0Q29uZmlnfTtcbiJdfQ==